<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal OS v6.1 (Lite)</title>
    
    <!-- 1. æ ¸å¿ƒå¥—ä»¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 2. Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <!-- 3. Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; overflow: hidden; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        /* Table Input Focus */
        .table-input:focus { background-color: #e0e7ff; outline: 2px solid #6366f1; z-index: 10; position: relative; border-radius: 2px; }
        th { white-space: nowrap; }
        th:focus { background-color: #e0e7ff; color: #4f46e5; outline: 2px solid #6366f1; outline-offset: -2px; }
    </style>
</head>
<body class="text-gray-900 overflow-hidden">
    <div id="root" class="h-screen w-full relative"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, Component } = React;

        // --- 0. é˜²ç•¶æ©Ÿä¿è­·ç½© ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Error:", error, errorInfo); }
            render() {
                if (this.state.hasError) return <div className="p-6 text-center text-red-500 bg-red-50 rounded-2xl border border-red-200 m-4 shadow-sm">âš ï¸ ç™¼ç”ŸéŒ¯èª¤: {this.state.error?.message} <br/><button onClick={()=>window.location.reload()} className="mt-2 underline font-bold">é‡æ–°æ•´ç†</button></div>;
                return this.props.children;
            }
        }

        // --- 1. Icons ---
        const SVG = ({ children, className, size = 24, onClick }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick}>
                {children}
            </svg>
        );

        const Icons = {
            Menu: (p) => <SVG {...p}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></SVG>,
            Home: (p) => <SVG {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></SVG>,
            Calendar: (p) => <SVG {...p}><rect width="18" height="18" x="3" y="4" rx="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></SVG>,
            Check: (p) => <SVG {...p}><path d="m9 11 3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></SVG>,
            Brief: (p) => <SVG {...p}><rect width="20" height="14" x="2" y="7" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></SVG>,
            CheckC: (p) => <SVG {...p}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></SVG>,
            Settings: (p) => <SVG {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.18-.08a2 2 0 0 0-2 0l-.45.26a2 2 0 0 0-.79 2.85l.18.31a2 2 0 0 1 0 2.36l-.18.31a2 2 0 0 0 .79 2.85l.45.26a2 2 0 0 0 2 0l.18-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.18.08a2 2 0 0 0 2 0l.45-.26a2 2 0 0 0 .79-2.85l-.18-.31a2 2 0 0 1 0-2.36l.18-.31a2 2 0 0 0-.79-2.85l-.45-.26a2 2 0 0 0-2 0l-.18.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></SVG>,
            Loader: (p) => <SVG {...p} className={`animate-spin ${p.className || ''}`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></SVG>,
            Sparkles: (p) => <SVG {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></SVG>,
            Zap: (p) => <SVG {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></SVG>,
            Clock: (p) => <SVG {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></SVG>,
            Users: (p) => <SVG {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></SVG>,
            Brain: (p) => <SVG {...p}><path d="M21 8.8c.5.3 1 .9 1 1.6 0 1.2-1.2 2.3-2.7 2.3-1.1 0-2.1-.6-2.5-1.5"/><path d="M17.5 16.1c.3.9 1.1 1.5 2 1.5 1.5 0 2.7-1.1 2.7-2.6 0-.7-.3-1.3-.8-1.7"/><path d="M16 12h.01"/><path d="M8 12h.01"/><path d="M12 16h.01"/><path d="M12 8h.01"/><path d="M3 8.8c-.5.3-1 .9-1 1.6 0 1.2 1.2 2.3 2.7 2.3 1.1 0 2.1-.6 2.5-1.5"/><path d="M6.5 16.1c-.3.9-1.1 1.5-2 1.5-1.5 0-2.7-1.1-2.7-2.6 0-.7.3-1.3.8-1.7"/><path d="M12 2a8 8 0 0 0-8 8v1a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-1a8 8 0 0 0-8-8z"/></SVG>,
            Cloud: (p) => <SVG {...p}><path d="M6 16.326A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 .5 8.973"/><path d="m13 12-3 5h4l-3 5"/></SVG>,
            FileText: (p) => <SVG {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></SVG>,
            Download: (p) => <SVG {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></SVG>,
            Refresh: (p) => <SVG {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></SVG>,
            Layout: (p) => <SVG {...p}><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></SVG>,
            X: (p) => <SVG {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></SVG>,
            Trash: (p) => <SVG {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></SVG>,
            ArrowLeft: (p) => <SVG {...p}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></SVG>,
            Pin: (p) => <SVG {...p}><line x1="12" y1="17" x2="12" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"/></SVG>,
            PinOff: (p) => <SVG {...p}><line x1="2" y1="2" x2="22" y2="22"/><line x1="12" y1="17" x2="12" y2="22"/><path d="M9 9v1.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V17h14v-1.76a2 2 0 0 0-1.11-1.79l-.31-.15"/><path d="M15 9.34V6h1a2 2 0 0 0 0-4H7.89"/></SVG>,
            Plus: (p) => <SVG {...p}><path d="M5 12h14"/><path d="M12 5v14"/></SVG>
        };

        // --- Config ---
        const APP_ID = 'personal-assistant-app';
        const DEFAULT_FIREBASE_CONFIG = {
            apiKey: "AIzaSyA1Yb1o-ZNALFNpA_z9srmu19Bt84vdMTg",
            authDomain: "work-new-82d8f.firebaseapp.com",
            projectId: "work-new-82d8f",
            storageBucket: "work-new-82d8f.firebasestorage.app",
            messagingSenderId: "410077962391",
            appId: "1:410077962391:web:8f4d73500abd9e678c49d2"
        };
        const PRIORITIES = {
            'urgent_important': { label: 'é‡è¦ä¸”ç·Šæ€¥', color: 'bg-red-100 text-red-800 border-red-200', icon: 'ğŸ”¥' },
            'not_urgent_important': { label: 'é‡è¦ä¸ç·Šæ€¥', color: 'bg-yellow-100 text-yellow-800 border-yellow-200', icon: 'â­' },
            'urgent_not_important': { label: 'ç·Šæ€¥ä¸é‡è¦', color: 'bg-orange-100 text-orange-800 border-orange-200', icon: 'âš¡' },
            'not_urgent_not_important': { label: 'ä¸æ€¥ä¸é‡è¦', color: 'bg-gray-100 text-gray-600 border-gray-200', icon: 'â˜•' }
        };
        const DEFAULT_CATEGORIES = ['å·¥ä½œ-å€‹æ¡ˆ', 'å·¥ä½œ-ä¸»è²¬', 'å·¥ä½œ-è¡Œæ”¿', 'å€‹äºº-å­¸ç¿’', 'å€‹äºº-æ¥æ¡ˆ'];
        const HOLIDAYS = { '2025-01-01': 'å…ƒæ—¦', '2025-01-25': 'æ˜¥ç¯€', '2025-01-26': 'æ˜¥ç¯€', '2025-01-27': 'é™¤å¤•', '2025-01-28': 'æ˜¥ç¯€', '2025-01-29': 'åˆäºŒ', '2025-01-30': 'åˆä¸‰', '2025-01-31': 'åˆå››', '2025-02-01': 'åˆäº”', '2025-02-28': '228', '2025-04-03': 'å…’ç«¥ç¯€', '2025-04-04': 'æ¸…æ˜ç¯€', '2025-05-30': 'ç«¯åˆé€£å‡', '2025-05-31': 'ç«¯åˆç¯€', '2025-10-06': 'ä¸­ç§‹ç¯€', '2025-10-10': 'åœ‹æ…¶æ—¥', '2026-01-01': 'å…ƒæ—¦', '2026-02-16': 'é™¤å¤•', '2026-02-17': 'æ˜¥ç¯€', '2026-02-18': 'åˆäºŒ', '2026-02-19': 'åˆä¸‰', '2026-02-20': 'åˆå››', '2026-02-21': 'åˆäº”', '2026-02-28': '228', '2026-04-03': 'å…’ç«¥ç¯€(è£œ)', '2026-04-04': 'å…’ç«¥ç¯€', '2026-04-05': 'æ¸…æ˜ç¯€', '2026-04-06': 'æ¸…æ˜è£œå‡', '2026-06-19': 'ç«¯åˆç¯€', '2026-09-25': 'ä¸­ç§‹ç¯€', '2026-10-10': 'åœ‹æ…¶æ—¥' };

        const formatDate = (date) => { const d = new Date(date); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; };
        
        const callGemini = async (apiKey, prompt, systemInstruction) => {
            if (!apiKey) return "API Key æœªè¨­å®š";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemInstruction }] }, generationConfig: { responseMimeType: "application/json" } }) });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (e) { console.error(e); return null; }
        };
        const Toast = ({ message, onClose }) => {
            useEffect(() => { const t = setTimeout(onClose, 2000); return () => clearTimeout(t); }, [onClose]);
            return <div className="fixed top-10 left-1/2 -translate-x-1/2 z-[200] px-4 py-2 rounded-full shadow-lg flex items-center gap-2 text-white bg-green-600 text-xs font-bold animate-in"><Icons.CheckC size={16}/>{message}</div>;
        };

        // --- Modules ---
        const Dashboard = ({ user, db }) => {
            const [urgentTodos, setUrgentTodos] = useState([]);
            const [upcomingTodos, setUpcomingTodos] = useState([]);
            
            useEffect(() => {
                if (!user || !db) return;
                const unsub = db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('todos')
                    .onSnapshot((snap) => {
                        const list = [];
                        snap.forEach(doc => { if (!doc.data().completed) list.push(doc.data()); });
                        setUrgentTodos(list.filter(t => t.priority === 'urgent_important').slice(0, 5));
                        
                        const today = new Date();
                        const nextWeek = new Date();
                        nextWeek.setDate(today.getDate() + 7);
                        setUpcomingTodos(list.filter(t => {
                            if (!t.dueDate) return false;
                            const d = new Date(t.dueDate);
                            return d >= today && d <= nextWeek;
                        }).sort((a,b)=>new Date(a.dueDate)-new Date(b.dueDate)).slice(0, 3));
                    }, err => console.error("Dashboard Error:", err));
                return () => unsub();
            }, [user, db]);
            
            return (
                <div className="space-y-4 p-4 animate-in">
                    <header className="flex justify-between items-center mb-4"><div><h1 className="text-2xl font-black text-gray-800">æ—©å®‰, {user && user.displayName ? user.displayName.split(' ')[0] : 'Boss'}</h1><p className="text-[9px] font-bold text-gray-400 tracking-widest">Personal OS v6.1</p></div><div className="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded-full font-bold">ONLINE</div></header>
                    <div className="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-[2rem] p-6 text-white shadow-xl relative overflow-hidden"><div className="relative z-10"><h2 className="text-lg font-bold mb-1">ä»Šæ—¥æ¦‚æ³</h2><p className="text-sm opacity-80">{formatDate(new Date())}</p></div><div className="absolute right-0 top-0 p-4 opacity-20"><Icons.Sparkles size={80}/></div></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-red-50 p-4 rounded-3xl border border-red-100">
                            <h3 className="font-bold text-red-800 mb-2 flex items-center gap-2"><Icons.Zap className="text-red-500" size={18}/> ç·Šæ€¥ä»»å‹™</h3>
                            <div className="space-y-2">{urgentTodos.length > 0 ? urgentTodos.map((t, i) => (<div key={i} className="bg-white p-2 rounded-xl text-xs text-red-700 font-bold border border-red-100">{t.text}</div>)) : <div className="text-center text-xs text-red-300">ç„¡ç·Šæ€¥äº‹é …</div>}</div>
                        </div>
                        <div className="bg-blue-50 p-4 rounded-3xl border border-blue-100">
                            <h3 className="font-bold text-blue-800 mb-2 flex items-center gap-2"><Icons.Clock className="text-blue-500" size={18}/> å³å°‡æˆªæ­¢ (7å¤©å…§)</h3>
                            <div className="space-y-2">{upcomingTodos.length > 0 ? upcomingTodos.map((t, i) => (<div key={i} className="bg-white p-2 rounded-xl text-xs text-blue-700 font-bold border border-blue-100 flex justify-between"><span>{t.text}</span><span className="text-blue-400">{t.dueDate}</span></div>)) : <div className="text-center text-xs text-blue-300">ç„¡è¿‘æœŸæˆªæ­¢</div>}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const CaseManager = ({ user, db, showToast }) => {
            const [sheets, setSheets] = useState(['èº«éšœæ¡ˆä»¶', 'ä¸­é«˜æ¡ˆä»¶']);
            const [activeSheet, setActiveSheet] = useState('èº«éšœæ¡ˆä»¶');
            const [rows, setRows] = useState([]);
            const [columns, setColumns] = useState(['æ¡ˆä¸»å§“å', 'é›»è©±', 'é¡åˆ¥', 'ç‹€æ…‹', 'è¿½è¹¤æ—¥', 'å‚™è¨»']);
            const [loading, setLoading] = useState(false);
            const [hasChanges, setHasChanges] = useState(false);
            const [focusedCell, setFocusedCell] = useState(null); 
            const [focusedHeader, setFocusedHeader] = useState(null); 

            useEffect(() => {
                if(!user || !db) return;
                setLoading(true);
                const unsub = db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('case_sheets').doc(activeSheet)
                    .onSnapshot(doc => {
                        if(doc.exists) {
                            const d = doc.data();
                            if(d.columns) setColumns(d.columns);
                            if(d.rows) setRows(d.rows);
                            else setRows(Array(5).fill({}));
                        } else {
                            setColumns(['æ¡ˆä¸»å§“å', 'é›»è©±', 'é¡åˆ¥', 'ç‹€æ…‹', 'è¿½è¹¤æ—¥', 'å‚™è¨»']);
                            setRows(Array(5).fill({}));
                        }
                        setLoading(false);
                    });
                return () => unsub();
            }, [user, db, activeSheet]);

            const save = async () => {
                if(!user) return;
                await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('case_sheets').doc(activeSheet).set({ columns, rows, updatedAt: Date.now() }, { merge: true });
                setHasChanges(false); showToast('å·²å„²å­˜');
            };

            const updateCell = (rIdx, col, val) => {
                const newRows = [...rows];
                newRows[rIdx] = { ...newRows[rIdx], [col]: val };
                setRows(newRows);
                setHasChanges(true);
            };

            const handlePaste = (e) => {
                const text = e.clipboardData.getData('text');
                if (!text) return;
                
                if (focusedHeader !== null) {
                    e.preventDefault();
                    const lines = text.trim().split(/\r\n|\n|\r/);
                    if (lines.length === 0) return;
                    const newHeaders = lines[0].split('\t').map(h => h.trim().replace(/^"|"$/g, ''));
                    const nextCols = [...columns];
                    newHeaders.forEach((h, i) => { if(!h) return; const targetIdx = focusedHeader + i; if (targetIdx < nextCols.length) nextCols[targetIdx] = h; else nextCols.push(h); });
                    setColumns(nextCols); setHasChanges(true); showToast(`æ›´æ–°æ¨™é¡Œ`); return;
                }

                if (text.includes('\t') || text.includes('\n')) {
                    e.preventDefault();
                    const lines = text.trim().split(/\r\n|\n|\r/).filter(l => l.trim());
                    if (lines.length === 0) return;
                    const newRows = [...rows];
                    let startRowIdx = newRows.length; let startColIdx = 0;
                    if (focusedCell) { startRowIdx = focusedCell.r; startColIdx = columns.indexOf(focusedCell.c); if (startColIdx === -1) startColIdx = 0; }

                    lines.forEach((line, i) => {
                        const vals = line.split('\t');
                        const targetRowIdx = startRowIdx + i;
                        if (!newRows[targetRowIdx]) newRows[targetRowIdx] = {};
                        vals.forEach((val, j) => {
                            const targetColIdx = startColIdx + j;
                            if (targetColIdx < columns.length) {
                                const colName = columns[targetColIdx];
                                newRows[targetRowIdx][colName] = val.replace(/^"|"$/g, '').trim();
                            }
                        });
                    });
                    setRows(newRows); setHasChanges(true); showToast(`è²¼ä¸Šè³‡æ–™`);
                }
            };

            const addColumn = () => { const name = prompt("æ¬„ä½åç¨±:"); if(name && !columns.includes(name)) { setColumns([...columns, name]); setHasChanges(true); }};
            const renameColumn = (idx) => {
                const oldName = columns[idx];
                const newName = prompt("ä¿®æ”¹åç¨± (æ¸…ç©ºåˆªé™¤)", oldName);
                if (newName === null) return;
                if (newName.trim() === "") {
                    if(confirm("åˆªé™¤æ­¤æ¬„ä½ï¼Ÿ")) {
                        const newCols = columns.filter((_, i) => i !== idx);
                        const newRows = rows.map(r => { const nr={...r}; delete nr[oldName]; return nr; });
                        setColumns(newCols); setRows(newRows); setHasChanges(true);
                    }
                    return;
                }
                if (newName !== oldName && !columns.includes(newName)) {
                    const newCols = [...columns]; newCols[idx] = newName;
                    const newRows = rows.map(r => { const val = r[oldName]; const nr={...r}; delete nr[oldName]; nr[newName] = val; return nr; });
                    setColumns(newCols); setRows(newRows); setHasChanges(true);
                }
            };

            const handleAddSheet = () => { const name = prompt("åˆ†é åç¨±:"); if(name && !sheets.includes(name)) { setSheets([...sheets, name]); setActiveSheet(name); } };
            const downloadExcel = () => { const wb = XLSX.utils.book_new(); const ws = XLSX.utils.json_to_sheet(rows); XLSX.utils.book_append_sheet(wb, ws, activeSheet); XLSX.writeFile(wb, `Case_List_${activeSheet}.xlsx`); };

            return (
                <div className="h-full flex flex-col p-4 animate-in" onPaste={handlePaste}>
                    <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-black text-gray-800 flex items-center gap-2"><Icons.FileText size={24}/> å€‹æ¡ˆç®¡ç†</h2><div className="flex gap-2">{hasChanges && <button onClick={save} className="px-4 py-2 bg-red-500 text-white rounded-xl text-xs font-bold shadow-lg animate-pulse">å„²å­˜è®Šæ›´</button>}<button onClick={downloadExcel} className="p-2 bg-green-100 text-green-700 rounded-xl hover:bg-green-200"><Icons.Download size={18}/></button></div></div>
                    <div className="flex gap-2 overflow-x-auto pb-2 custom-scrollbar mb-2">{sheets.map(s => (<button key={s} onClick={()=>setActiveSheet(s)} className={`px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all ${activeSheet === s ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-gray-500 border border-gray-200'}`}>{s}</button>))}<button onClick={handleAddSheet} className="px-3 py-2 rounded-xl border border-dashed border-gray-300 text-gray-400 text-xs hover:border-indigo-400">+</button></div>
                    <div className="flex-1 bg-white rounded-[1.5rem] shadow-sm border border-gray-200 overflow-hidden flex flex-col relative">
                        {loading ? <div className="absolute inset-0 flex items-center justify-center bg-white/80 z-10 text-gray-500 text-xs gap-2"><Icons.Loader/> è®€å–ä¸­...</div> : 
                        <div className="flex-1 overflow-auto custom-scrollbar p-4">
                            <table className="w-full text-left border-collapse min-w-[600px]">
                                <thead>
                                    <tr className="border-b border-gray-100">
                                        {columns.map((c, i) => <th key={i} tabIndex={0} onFocus={() => { setFocusedHeader(i); setFocusedCell(null); }} onDoubleClick={()=>renameColumn(i)} className="p-2 text-[10px] font-black text-gray-400 uppercase tracking-wider sticky top-0 bg-white z-10 cursor-pointer hover:text-indigo-500 focus:bg-indigo-50">{c}</th>)}
                                        <th className="w-10 sticky top-0 bg-white z-10"><button onClick={addColumn} className="p-1 hover:bg-gray-100 rounded text-indigo-500"><Icons.Plus size={14}/></button></th>
                                    </tr>
                                </thead>
                                <tbody>{rows.map((row, rIdx) => (<tr key={rIdx} className="border-b border-gray-50 hover:bg-gray-50 group">{columns.map((col, cIdx) => <td key={col} className="p-1"><input className="w-full bg-transparent text-xs p-1 rounded focus:bg-indigo-50 outline-none table-input" value={row[col]||''} onChange={e=>updateCell(rIdx, col, e.target.value)} onFocus={() => { setFocusedCell({r: rIdx, c: col}); setFocusedHeader(null); }}/></td>)}<td className="p-1"><button onClick={()=>{const n=[...rows];n.splice(rIdx,1);setRows(n);setHasChanges(true);}} className="text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100"><Icons.Trash size={14}/></button></td></tr>))}</tbody>
                            </table>
                            <button onClick={()=>setRows([...rows, {}])} className="w-full py-3 text-center text-xs text-gray-400 hover:bg-gray-50 border-t border-dashed border-gray-200">+ æ–°å¢ä¸€åˆ—</button>
                        </div>}
                    </div>
                </div>
            );
        };

        const SchedulePlanner = ({ user, db, showToast, geminiKey }) => {
            const [aiSchedule, setAiSchedule] = useState([]);
            const [isGenerating, setIsGenerating] = useState(false);
            const [urgentTodos, setUrgentTodos] = useState([]);
            useEffect(() => { if (!user || !db) return; return db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('todos').onSnapshot(snap => { const todos = []; snap.forEach(doc => { if(!doc.data().completed) todos.push({id: doc.id, ...doc.data()}); }); setUrgentTodos(todos); }); }, [user, db]);
            const handleGenerate = async () => { setIsGenerating(true); const todoList = urgentTodos.length > 0 ? JSON.stringify(urgentTodos.map(t => ({ id: t.id, text: t.text }))) : "ç„¡ç‰¹åˆ¥å¾…è¾¦"; const prompt = `ä»Šå¤©æ˜¯ ${formatDate(new Date())}ã€‚å·¥ä½œæ™‚é–“ 09:00-12:00, 13:00-17:00ã€‚å¾…è¾¦: ${todoList}ã€‚è«‹è¦åŠƒè¡Œç¨‹ï¼Œå›å‚³JSON Array: [{"time": "09:00", "task": "äº‹é …", "todoId": "ID/null", "type": "work/break"}]`; const res = await callGemini(geminiKey, prompt, "åªå›å‚³JSON Array"); if (res) { try { const jsonMatch = res.match(/\[[\s\S]*\]/); if (jsonMatch) setAiSchedule(JSON.parse(jsonMatch[0])); } catch(e) { alert("æ ¼å¼éŒ¯èª¤"); } } setIsGenerating(false); };
            const completeTask = async (item) => { const newSchedule = aiSchedule.map(s => s === item ? { ...s, completed: !s.completed } : s); setAiSchedule(newSchedule); if (item.todoId) { await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('todos').doc(item.todoId).update({ completed: !item.completed }); showToast(!item.completed ? "å·²å®Œæˆ" : "å·²å–æ¶ˆ"); } };
            return (
                <div className="p-4 space-y-4 animate-in"><h2 className="text-xl font-black text-gray-800 flex items-center gap-2"><Icons.Brain size={24}/> AI æ™ºèƒ½èª²è¡¨</h2>{aiSchedule.length === 0 ? (<div className="text-center p-10 bg-white rounded-[2rem] border border-gray-100 shadow-sm"><div className="w-12 h-12 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-3"><Icons.Sparkles className="text-indigo-500"/></div><p className="text-sm font-bold text-gray-700 mb-4">å°šæœªå®‰æ’è¡Œç¨‹</p><button onClick={handleGenerate} disabled={isGenerating} className="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-lg hover:bg-indigo-700 disabled:opacity-50">{isGenerating ? "è¦åŠƒä¸­..." : "ä¸€éµç”Ÿæˆè¡Œç¨‹"}</button></div>) : (<div className="space-y-3"><div className="flex justify-end"><button onClick={()=>setAiSchedule([])} className="text-xs text-red-400 bg-red-50 px-3 py-1 rounded-lg">é‡ç½®</button></div>{aiSchedule.map((item, i) => (<div key={i} onClick={()=>completeTask(item)} className={`flex items-center gap-4 p-4 rounded-2xl border cursor-pointer transition-all ${item.type==='break'?'bg-gray-50 border-gray-100':(item.completed?'bg-green-50 border-green-200 opacity-60':'bg-white border-gray-100 shadow-sm hover:shadow-md')}`}><span className="text-xs font-mono text-gray-400 font-bold">{item.time}</span><span className={`flex-1 text-sm font-bold ${item.completed?'line-through text-gray-400':'text-gray-800'}`}>{item.task}</span>{item.completed && <Icons.CheckC className="text-green-500" size={18}/>}</div>))}</div>)}</div>
            );
        };

        const TodoManager = ({ user, db, showToast }) => {
            const [todos, setTodos] = useState([]); const [newTodo, setNewTodo] = useState(''); const [category, setCategory] = useState('å·¥ä½œ-å€‹æ¡ˆ'); const [priority, setPriority] = useState('urgent_important'); const [categories, setCategories] = useState(DEFAULT_CATEGORIES); const [workCases, setWorkCases] = useState([]); const [selectedCase, setSelectedCase] = useState('');
            useEffect(() => { 
                if (!user || !db) return;
                const fetchCases = async () => {
                    const snap = await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('case_sheets').get();
                    let allNames = [];
                    snap.forEach(doc => { const d = doc.data(); if (d.rows && d.columns.length > 0) { const nameCol = d.columns[0]; d.rows.forEach(r => { if(r[nameCol]) allNames.push(r[nameCol]); }); } });
                    setWorkCases([...new Set(allNames)]); 
                };
                fetchCases();
                db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('settings').doc('todo_cats').get().then(doc => { if(doc.exists) setCategories(doc.data().list); }); 
                return db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('todos').onSnapshot(snap => { const list = []; snap.forEach(doc => list.push({id: doc.id, ...doc.data()})); setTodos(list.sort((a,b) => b.createdAt - a.createdAt)); }); 
            }, [user, db]);
            
            const handleAddCategory = async () => { const newCat = prompt("æ–°åˆ†é¡åç¨±ï¼š"); if (newCat && !categories.includes(newCat)) { const newList = [...categories, newCat]; setCategories(newList); setCategory(newCat); await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('settings').doc('todo_cats').set({ list: newList }, { merge: true }); }};
            const addTodo = async () => { if (!newTodo) return; let t = newTodo; if(selectedCase) t = `[${selectedCase}] ${t}`; await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('todos').add({ text: t, category, priority, completed: false, createdAt: Date.now() }); setNewTodo(''); showToast('å·²æ–°å¢'); };
            const deleteTodo = async (id) => { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('todos').doc(id).delete(); }
            const toggleTodo = async (t) => { await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('todos').doc(t.id).update({completed: !t.completed}); }
            
            return (
                <div className="p-4 space-y-4 animate-in pb-20 md:pb-0"><h2 className="text-xl font-black text-gray-800 flex items-center gap-2"><Icons.Check size={24}/> å¾…è¾¦äº‹é …</h2><div className="bg-white p-4 rounded-[2rem] shadow-sm space-y-3"><input className="w-full bg-gray-50 p-3 rounded-xl text-sm font-bold outline-none" placeholder="è¼¸å…¥äº‹é …..." value={newTodo} onChange={e=>setNewTodo(e.target.value)}/><div className="flex gap-2 overflow-x-auto pb-1 custom-scrollbar">{workCases.length>0 && <select className="bg-gray-50 p-2 rounded-lg text-xs font-bold border-none outline-none min-w-[100px]" value={selectedCase} onChange={e=>setSelectedCase(e.target.value)}><option value="">é¸æ“‡å€‹æ¡ˆ</option>{workCases.map((c,i)=><option key={i} value={c}>{c}</option>)}</select>}<select className="bg-gray-50 p-2 rounded-lg text-xs font-bold border-none outline-none" value={category} onChange={e=>setCategory(e.target.value)}>{categories.map(c=><option key={c} value={c}>{c}</option>)}<option value="add">+ æ–°å¢åˆ†é¡</option></select><select className="bg-gray-50 p-2 rounded-lg text-xs font-bold border-none outline-none" value={priority} onChange={e=>setPriority(e.target.value)}><option value="urgent_important">ğŸ”¥ æ€¥é‡</option><option value="not_urgent_important">â­ é‡</option><option value="urgent_not_important">âš¡ æ€¥</option><option value="not_urgent_not_important">â˜• é–’</option></select></div><button onClick={addTodo} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700">+</button></div><div className="space-y-2">{todos.map(t => (<div key={t.id} className={`p-4 bg-white rounded-2xl shadow-sm border border-gray-50 flex gap-3 ${t.completed?'opacity-50 grayscale':''}`}><button onClick={()=>toggleTodo(t)} className={`mt-1 p-1 border-2 rounded-full ${t.completed?'bg-green-500 border-green-500 text-white':'border-gray-200'}`}><Icons.CheckC size={14}/></button><div className="flex-1 min-w-0"><div className={`text-sm font-bold ${t.completed?'line-through':''}`}>{t.text}</div><div className="flex gap-1 mt-1"><span className="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-lg">{t.category}</span><span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded-lg">{t.priority==='urgent_important'?'ğŸ”¥ æ€¥':(t.priority==='not_urgent_important'?'â­ é‡':'â˜•')}</span></div></div><button onClick={()=>deleteTodo(t.id)} className="text-gray-300 hover:text-red-400"><Icons.Trash/></button></div>))}</div></div>
            );
        };

        const CalendarView = ({ user, db, showToast }) => {
            const [events, setEvents] = useState([]); const [currentDate, setCurrentDate] = useState(new Date()); const [modalData, setModalData] = useState(null);
            const days = useMemo(() => { const dInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate(); const first = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay(); const arr = []; for(let i=0; i<first; i++) arr.push(null); for(let i=1; i<=dInMonth; i++) arr.push(i); return arr; }, [currentDate]);
            useEffect(() => { if (!user || !db) return; const unsub = db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('calendar_events').onSnapshot((snap) => { const data = []; snap.forEach(doc => data.push({ ...doc.data(), id: doc.id })); setEvents(data); }); return () => unsub(); }, [user, db]);
            
            const EventModal = ({ event, date, onClose, onSave, onDelete }) => {
                const [form, setForm] = useState(event || { date, timeSlot:'ä¸Šåˆ', workItem:'è¨ªè¦–', area:'é«˜é›„', note:'' });
                return <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div className="bg-white rounded-2xl w-full max-w-sm p-6 space-y-4"><div className="flex justify-between font-bold text-lg"><h3>{event?'ç·¨è¼¯':'æ–°å¢'}è¡Œç¨‹</h3><button onClick={onClose}><Icons.X/></button></div><div className="space-y-3"><div className="flex gap-2"><input type="date" className="flex-1 bg-gray-50 p-2 rounded-lg" value={form.date} onChange={e=>setForm({...form, date:e.target.value})}/><select className="flex-1 bg-gray-50 p-2 rounded-lg" value={form.timeSlot} onChange={e=>setForm({...form, timeSlot:e.target.value})}> <option>ä¸Šåˆ</option><option>ä¸‹åˆ</option></select></div><select className="w-full bg-gray-50 p-2 rounded-lg" value={form.workItem} onChange={e=>setForm({...form, workItem:e.target.value})}>{['è¨ªè¦–','å¯©æŸ¥æœƒ','æˆæ•ˆ'].map(i=><option key={i}>{i}</option>)}</select><div className="flex flex-wrap gap-1">{['é«˜é›„','å±æ±','å°æ±'].map(a=><button key={a} onClick={()=>setForm({...form, area:a})} className={`px-2 py-1 text-xs border rounded ${form.area===a?'bg-indigo-600 text-white':''}`}>{a}</button>)}</div></div><div className="flex gap-2">{event && <button onClick={()=>onDelete(event.id)} className="p-3 bg-red-50 text-red-500 rounded-xl"><Icons.Trash/></button>}<button onClick={()=>onSave(form)} className="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl">å„²å­˜</button></div></div></div>;
            };

            return (
                <div className="p-4 space-y-4 animate-in pb-20">
                    <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-gray-100 mb-6"><div className="flex justify-between items-center mb-6"><h2 className="text-xl font-black">{currentDate.toLocaleString('zh-TW', {year:'numeric', month:'long'})}</h2><div className="flex bg-gray-100 rounded-xl"><button onClick={()=>setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth()-1)))} className="p-2"><Icons.Layout size={16} className="rotate-180"/></button><button onClick={()=>setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth()+1)))} className="p-2"><Icons.Layout size={16}/></button></div></div><div className="grid grid-cols-7 gap-1 text-center text-xs font-bold text-gray-400 mb-2"><div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div></div><div className="grid grid-cols-7 gap-1">{days.map((d,i)=>{ const dateStr = d?`${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`:''; const isToday = formatDate(new Date()) === dateStr; const hasEvent = events.some(e=>e.date===dateStr); const holiday = HOLIDAYS[dateStr]; return <div key={i} onClick={()=>d && setModalData({date:dateStr})} className={`min-h-[50px] border rounded-xl p-1 flex flex-col items-center justify-center ${d?(isToday?'bg-yellow-400 text-white font-bold':'text-gray-600 hover:bg-gray-50'):'border-transparent'}`}>{d}{holiday && <span className="text-[8px] text-red-500 mt-1">{holiday}</span>}{hasEvent&&<div className="w-1.5 h-1.5 bg-blue-500 rounded-full mt-1"></div>}</div>; })}</div></div>
                    {modalData && <EventModal event={modalData.event} date={modalData.date} onClose={()=>setModalData(null)} onSave={async(d)=>{ if(modalData.event) await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('calendar_events').doc(modalData.event.id).update(d); else await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('calendar_events').add(d); setModalData(null); showToast('å·²å„²å­˜'); }} onDelete={async(id)=>{ if(confirm("åˆªé™¤ï¼Ÿ")) await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('calendar_events').doc(id).delete(); setModalData(null); }}/>}
                    <div className="space-y-2">{events.filter(e=>e.date.startsWith(formatDate(currentDate).slice(0,7))).sort((a,b)=>a.date.localeCompare(b.date)).map(ev=><div key={ev.id} onClick={()=>setModalData({event:ev})} className="bg-white p-4 rounded-2xl shadow-sm border flex justify-between items-center cursor-pointer hover:bg-gray-50"><div><div className="text-xs text-indigo-500 font-bold">{ev.date} {ev.timeSlot}</div><div className="font-bold">{ev.workItem} <span className="text-xs text-gray-400 font-normal">{ev.area}</span></div></div></div>)}</div>
                </div>
            );
        };

        const Settings = ({ user, geminiKey, setGeminiKey, handleGoogleLogin }) => (
            <div className="p-4 space-y-6 animate-in pb-20 md:pb-0"><h2 className="text-xl font-black text-gray-800">ç³»çµ±è¨­å®š</h2><div className="bg-indigo-50 border border-indigo-100 rounded-2xl p-5"><h3 className="font-bold text-indigo-900 mb-2 flex items-center gap-2"><Icons.Users size={18}/> å¸³è™Ÿç‹€æ…‹</h3><div className="text-xs text-indigo-600 mb-4">{user?.isAnonymous ? 'âš ï¸ è¨ªå®¢æ¨¡å¼ (è³‡æ–™æœªåŒæ­¥)' : `âœ… å·²ç™»å…¥ï¼š${user?.email}`}</div>{(!user || user.isAnonymous) ? <button onClick={handleGoogleLogin} className="w-full bg-white text-indigo-600 py-3 rounded-xl font-bold shadow-sm border border-indigo-100">Google ç™»å…¥</button> : <button onClick={()=>firebase.auth().signOut()} className="w-full bg-red-50 text-red-500 py-3 rounded-xl font-bold border border-red-100">ç™»å‡º</button>}</div><div className="bg-white border border-gray-200 rounded-2xl p-5"><label className="block text-xs font-bold text-gray-500 mb-2">Gemini API Key</label><input type="password" value={geminiKey} onChange={e=>{setGeminiKey(e.target.value); localStorage.setItem('gemini_key',e.target.value)}} className="w-full bg-gray-50 p-3 rounded-xl text-sm font-mono border-none outline-none"/></div></div>
        );

        // --- App ---
        const App = () => {
            const [tab, setTab] = useState('home');
            const [isSidebarLocked, setIsSidebarLocked] = useState(true); 
            const [isSidebarOpen, setIsSidebarOpen] = useState(false); 
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [toast, setToast] = useState(null);
            const [geminiKey, setGeminiKey] = useState(()=>localStorage.getItem('gemini_key') || 'AIzaSyC6mOZd-_wWykvfLfr3IlpSKkuvsgZv9y4');

            useEffect(() => {
                const handleResize = () => { 
                    const mobile = window.innerWidth < 768; 
                    setIsMobile(mobile);
                    if (mobile) setIsSidebarLocked(false); 
                };
                window.addEventListener('resize', handleResize); 
                handleResize();

                if(!firebase.apps.length) firebase.initializeApp(DEFAULT_FIREBASE_CONFIG);
                const auth = firebase.auth(); setDb(firebase.firestore());
                auth.onAuthStateChanged(u => { setUser(u); if(!u) auth.signInAnonymously(); });
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            const handleGoogleLogin = async () => { try { await firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider()); setToast("ç™»å…¥æˆåŠŸ"); } catch(e) { alert("ç™»å…¥å¤±æ•—: "+e.message); } };
            const switchTab = (t) => { setTab(t); if(!isSidebarLocked) setIsSidebarOpen(false); };

            const MENU_ITEMS = [
                { id: 'home', label: 'ç¸½è¦½', icon: Icons.Home },
                { id: 'workflow', label: 'æµç¨‹ SOP', icon: Icons.Brief },
                { id: 'schedule', label: 'æ™ºèƒ½èª²è¡¨', icon: Icons.Brain },
                { id: 'cases', label: 'å€‹æ¡ˆè¡¨', icon: Icons.FileText },
                { id: 'todo', label: 'å¾…è¾¦äº‹é …', icon: Icons.Check },
                { id: 'calendar', label: 'è¡Œäº‹æ›†', icon: Icons.Calendar },
                { id: 'settings', label: 'è¨­å®š', icon: Icons.Settings },
            ];

            return (
                <div className="flex h-screen w-full relative overflow-hidden bg-slate-50">
                    {toast && <Toast message={toast} onClose={()=>setToast(null)}/>}

                    {/* Left Sidebar */}
                    <div className={`fixed inset-y-0 left-0 z-40 w-64 bg-white border-r border-gray-100 transform transition-transform duration-300 ease-in-out ${(isSidebarLocked || isSidebarOpen) ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 h-full flex flex-col">
                            <div className="flex justify-between items-center mb-8 mt-2">
                                <h2 className="text-xl font-black text-gray-800 flex items-center gap-2"><Icons.Brief className="text-indigo-600" size={24}/> Personal OS</h2>
                                {!isMobile && (
                                    <button onClick={() => setIsSidebarLocked(!isSidebarLocked)} className="text-gray-400 hover:text-indigo-600">
                                        {isSidebarLocked ? <Icons.Pin size={18}/> : <Icons.PinOff size={18}/>}
                                    </button>
                                )}
                            </div>
                            <nav className="flex-1 space-y-1 overflow-y-auto custom-scrollbar pr-2">
                                {MENU_ITEMS.map(item => (
                                    <button key={item.id} onClick={() => switchTab(item.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-2xl text-xs font-bold transition-all ${tab === item.id ? 'bg-indigo-50 text-indigo-600 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}>
                                        <item.icon size={18} /> {item.label}
                                    </button>
                                ))}
                            </nav>
                            <div className="text-[10px] text-gray-300 text-center mt-4">v6.1 Lite</div>
                        </div>
                    </div>

                    {/* Overlay for mobile or unlocked desktop */}
                    {!isSidebarLocked && isSidebarOpen && <div className="fixed inset-0 bg-black/20 z-30" onClick={() => setIsSidebarOpen(false)}></div>}

                    {/* Main Content */}
                    <main className={`flex-1 h-full overflow-y-auto custom-scrollbar transition-all duration-300 ${isSidebarLocked ? 'ml-64' : 'ml-0'}`}>
                        <div className="p-4 pt-16 md:pt-4 max-w-3xl mx-auto h-full">
                            <ErrorBoundary>
                                {tab === 'home' && <Dashboard user={user} db={db} />}
                                {tab === 'workflow' && <WorkflowManager user={user} db={db} showToast={setToast} />}
                                {tab === 'schedule' && <SchedulePlanner user={user} db={db} showToast={setToast} geminiKey={geminiKey} />}
                                {tab === 'cases' && <CaseManager user={user} db={db} showToast={setToast} />}
                                {tab === 'todo' && <TodoManager user={user} db={db} showToast={setToast} />}
                                {tab === 'calendar' && <CalendarView user={user} db={db} showToast={setToast} />}
                                {tab === 'settings' && <Settings user={user} geminiKey={geminiKey} setGeminiKey={setGeminiKey} handleGoogleLogin={handleGoogleLogin} />}
                            </ErrorBoundary>
                        </div>
                    </main>

                    {/* Toggle Button (Visible when sidebar is hidden/unlocked) */}
                    {(!isSidebarLocked || isMobile) && (
                        <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="fixed z-50 p-3 rounded-full shadow-lg transition-all duration-300 bg-white border border-gray-100 text-gray-600 hover:text-indigo-600 bottom-6 left-6">
                            {isSidebarOpen ? <Icons.ArrowLeft size={24}/> : <Icons.Menu size={24}/>}
                        </button>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>