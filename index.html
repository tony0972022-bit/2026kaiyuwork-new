<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ˜“ç¶“å‘½ç†å¤§å¸« - é›²ç«¯è§£æƒ‘</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs (Compat version) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics-compat.js"></script>
    
    <!-- HTML2Canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Serif TC', serif;
            background-color: #Fdfbf7;
            background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.3s ease-in-out;
        }

        .book-cover {
            background: linear-gradient(135deg, #292524 0%, #1c1917 100%);
            box-shadow: 
                -5px 0 10px rgba(0,0,0,0.5),
                inset 2px 2px 5px rgba(255,255,255,0.1),
                10px 10px 20px rgba(0,0,0,0.3);
            border-left: 8px solid #44403c;
        }

        .book-page {
            background-color: #fff;
            background-image: linear-gradient(90deg, transparent 0%, rgba(0,0,0,0.03) 5%, transparent 10%),
                            linear-gradient(#e5e5e5 1px, transparent 1px);
            background-size: 100% 100%, 100% 24px;
            box-shadow: 1px 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .book-page::after {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            border-width: 0 12px 12px 0;
            border-style: solid;
            border-color: #f5f5f4 #f5f5f4 #d6d3d1 #d6d3d1; 
            box-shadow: -1px 1px 2px rgba(0,0,0,0.1);
        }

        .vertical-text {
            writing-mode: vertical-rl;
            text-orientation: upright;
            letter-spacing: 0.2em;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="text-stone-800 min-h-screen selection:bg-amber-200 flex flex-col items-center relative">

    <div class="max-w-2xl w-full px-6 py-8 flex-grow flex flex-col">
        
        <!-- View 0: Cover (å°é¢) -->
        <div id="view-cover" class="fade-in flex flex-col items-center justify-center flex-grow py-12 relative">
            <div class="book-cover w-64 h-80 rounded-r-xl rounded-l-sm flex flex-col items-center justify-center text-amber-50 mb-10 relative overflow-hidden transition-transform hover:scale-[1.02] duration-500 cursor-pointer" onclick="enterApp()">
                <div class="absolute top-4 right-4 opacity-20">
                    <i data-lucide="cloud" class="w-24 h-24"></i>
                </div>
                <div class="border-2 border-amber-500/30 p-1 mb-6">
                    <div class="w-16 h-16 bg-stone-800 rounded-full flex items-center justify-center text-amber-100 text-3xl font-bold border border-amber-500/50">
                        æ˜“
                    </div>
                </div>
                <h1 class="text-3xl font-bold tracking-[0.3em] text-center border-t border-b border-amber-500/20 py-4 w-4/5">æ˜“ç¶“è§£æƒ‘</h1>
                <p class="mt-6 text-xs text-stone-400 tracking-widest uppercase">The Book of Changes</p>
            </div>
            
            <div class="flex gap-4">
                <button onclick="enterApp()" class="group relative px-6 py-3 bg-stone-900 text-amber-50 rounded-full font-bold shadow-xl hover:bg-stone-800 transition-all flex items-center gap-2">
                    <span class="tracking-widest">é–‹å•Ÿæ™ºæ…§ä¹‹é–€</span>
                    <i data-lucide="arrow-right" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i>
                </button>
                <button onclick="showHistorySearch()" class="px-4 py-3 bg-white text-stone-700 border border-stone-300 rounded-full font-bold shadow-md hover:bg-stone-50 transition-all flex items-center gap-2" title="æŸ¥è©¢æ­·å²ç´€éŒ„">
                    <i data-lucide="history" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">æˆ‘çš„ç´€éŒ„</span>
                </button>
            </div>
            <p class="mt-6 text-stone-400 text-xs">èª å¿ƒå•å¦ Â· éš¨æ©Ÿç¿»æ›¸ Â· AIè§£æƒ‘</p>
            
            <!-- ç®¡ç†å“¡å…¥å£ -->
            <button onclick="showAdminLogin()" class="absolute bottom-0 right-0 p-2 text-stone-300 hover:text-stone-600 transition-colors opacity-50 hover:opacity-100" title="ç®¡ç†å“¡å…¥å£">
                <i data-lucide="lock" class="w-4 h-4"></i>
            </button>
        </div>

        <!-- View 1: Input (è¼¸å…¥è³‡æ–™) -->
        <div id="view-input" class="hidden fade-in space-y-6 pt-4">
            <div class="text-center mb-6 flex items-center justify-center gap-3 opacity-60">
                <div class="w-8 h-8 bg-stone-900 rounded-full flex items-center justify-center text-white text-sm font-bold">æ˜“</div>
                <span class="font-bold tracking-widest text-stone-900">é›²ç«¯æ˜“ç¶“å‘½ç†å¸«</span>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200 space-y-5">
                <div class="grid grid-cols-2 gap-4 pb-4 border-b border-stone-100">
                    <div class="col-span-2 sm:col-span-1 space-y-1">
                        <label class="block text-xs font-bold text-stone-500 uppercase tracking-wider">å§“å (å¿…å¡«)</label>
                        <input type="text" id="user-name" placeholder="æ‚¨çš„ç¨±å‘¼" 
                            class="w-full p-2 bg-stone-50 border border-stone-200 rounded focus:border-amber-500 focus:ring-1 focus:ring-amber-500 outline-none transition">
                    </div>
                    
                    <div class="col-span-2 sm:col-span-1 space-y-1">
                        <label class="block text-xs font-bold text-stone-500 uppercase tracking-wider flex items-center gap-1">
                            æŸ¥è©¢å¯†ç¢¼ <span class="text-stone-300 font-normal normal-case">(é¸å¡«)</span>
                        </label>
                        <input type="text" id="user-password" placeholder="è¨­å®šå¯†ç¢¼ä»¥ä¿è­·ç´€éŒ„" 
                            class="w-full p-2 bg-stone-50 border border-stone-200 rounded focus:border-amber-500 focus:ring-1 focus:ring-amber-500 outline-none transition">
                    </div>

                    <div class="col-span-1 space-y-1">
                        <label class="block text-xs font-bold text-stone-500 uppercase tracking-wider">æ€§åˆ¥</label>
                        <select id="user-gender" class="w-full p-2 bg-stone-50 border border-stone-200 rounded focus:border-amber-500 focus:ring-1 focus:ring-amber-500 outline-none transition">
                            <option value="ç”·">ç”·</option>
                            <option value="å¥³">å¥³</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="col-span-1 space-y-1">
                        <label class="block text-xs font-bold text-stone-500 uppercase tracking-wider">è™›æ­²</label>
                        <input type="number" id="user-age" placeholder="æ­²æ•¸" min="1" max="120"
                            class="w-full p-2 bg-stone-50 border border-stone-200 rounded focus:border-amber-500 focus:ring-1 focus:ring-amber-500 outline-none transition">
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="block text-stone-700 font-bold text-lg flex items-center gap-2">
                        <i data-lucide="feather" class="w-5 h-5 text-amber-600"></i>
                        è«‹å•æ‚¨æƒ³æ¸¬ç®—çš„äº‹æƒ…æ˜¯ï¼Ÿ
                    </label>
                    <textarea id="question-input"
                        placeholder="åœ¨æ­¤å¯«ä¸‹æ‚¨çš„ç–‘æƒ‘...&#10;ä¾‹å¦‚ï¼šæœ€è¿‘çš„å·¥ä½œé‹å‹¢å¦‚ä½•ï¼Ÿé€™æ®µæ„Ÿæƒ…æœƒæœ‰çµæœå—ï¼Ÿ"
                        class="w-full h-32 p-4 bg-stone-50 rounded-lg border border-stone-200 focus:ring-2 focus:ring-amber-500/50 focus:border-amber-500 outline-none transition resize-none text-lg leading-relaxed"></textarea>
                </div>
            </div>
            
            <div class="flex gap-3">
                 <button onclick="switchView('view-cover')" class="px-6 py-4 rounded-lg bg-stone-200 text-stone-600 font-bold hover:bg-stone-300 transition-colors">
                    è¿”å›
                </button>
                <button onclick="startDivination()" id="start-btn"
                    class="flex-1 py-4 rounded-lg text-lg font-bold tracking-widest transition-all transform flex items-center justify-center gap-2 bg-stone-800 text-white shadow-lg hover:bg-stone-700 active:scale-[0.98] cursor-pointer">
                    <i data-lucide="sparkles"></i>
                    é–‹å§‹å†¥æƒ³æ±‚å¦
                </button>
            </div>
        </div>

        <!-- View 2: Meditating -->
        <div id="view-meditating" class="hidden fade-in text-center py-8">
            <h2 class="text-xl text-stone-600 mb-2 font-bold">å¿ƒä¸­é»˜å¿µå•é¡Œ</h2>
            <p class="text-stone-400 text-sm mb-10">é»æ“ŠæŒ‰éˆ•éš¨æ©Ÿç¿»é–±å¤ç±</p>
            
            <div class="flex justify-center gap-3 sm:gap-6 mb-12">
                <div id="numbers-container" class="flex gap-3 sm:gap-6"></div>
            </div>

            <button onclick="flipPage()" id="flip-btn"
                class="px-10 py-4 bg-stone-800 text-white rounded-lg shadow-xl hover:bg-stone-700 hover:-translate-y-1 transition-all flex items-center gap-3 mx-auto border-b-4 border-stone-950">
                <i data-lucide="book-open"></i>
                <span id="flip-btn-text" class="tracking-widest">ç¿»é–‹ç¬¬ä¸€é </span>
            </button>
            
            <p id="flip-hint" class="mt-6 text-amber-700/60 text-xs animate-pulse hidden">æ­£åœ¨å¿«é€Ÿç¿»é–±æ›¸é ...</p>
        </div>

        <!-- View 3: Result -->
        <div id="view-result" class="hidden fade-in pb-20">
            <!-- Capture Area Start -->
            <div id="result-capture-area" class="bg-white rounded-xl shadow-xl border border-stone-200 overflow-hidden mb-6 relative">
                <!-- Watermark -->
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-5 pointer-events-none select-none z-0">
                    <i data-lucide="cloud" class="w-96 h-96"></i>
                </div>

                <!-- Result Header -->
                <div class="bg-stone-900 text-amber-50 p-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 relative z-10">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span id="result-user-info" class="px-2 py-0.5 rounded bg-stone-700 text-amber-200 text-[10px] uppercase tracking-wider">
                                æ±‚åœè€…è³‡è¨Š
                            </span>
                        </div>
                        <h2 class="text-xs text-stone-400 uppercase tracking-widest mb-1">æ‚¨çš„å•é¡Œ</h2>
                        <p id="result-question" class="text-lg font-bold line-clamp-2">...</p>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <div id="result-hex-name" class="text-3xl font-bold font-serif">...</div>
                        <div id="result-sentiment" class="text-xs text-amber-400 mt-1 tracking-widest">...</div>
                    </div>
                </div>

                <!-- Hexagram Visual -->
                <div class="p-8 flex flex-col md:flex-row gap-8 items-center justify-center border-b border-stone-100 bg-stone-50/90 relative z-10">
                    <div class="flex flex-col items-center gap-2">
                        <div class="flex flex-col gap-1 w-32 p-4 bg-white rounded shadow-sm border border-stone-200">
                            <div id="upper-img" class="text-center text-5xl mb-2 text-stone-800 h-14 flex items-center justify-center font-serif leading-none">â˜°</div>
                            <div id="upper-name" class="text-center text-xs text-stone-500 border-t border-stone-100 pt-2 tracking-widest">ä¸Šå¦</div>
                        </div>
                        <div class="flex flex-col gap-1 w-32 p-4 bg-white rounded shadow-sm border border-stone-200">
                            <div id="lower-img" class="text-center text-5xl mb-2 text-stone-800 h-14 flex items-center justify-center font-serif leading-none">â˜·</div>
                            <div id="lower-name" class="text-center text-xs text-stone-500 border-t border-stone-100 pt-2 tracking-widest">ä¸‹å¦</div>
                        </div>
                    </div>

                    <div class="flex-1 w-full">
                        <div class="bg-white p-5 rounded-lg border border-stone-200 shadow-sm">
                            <h3 class="font-bold text-stone-800 mb-4 flex items-center gap-2 text-sm uppercase tracking-wider">
                                <i data-lucide="scroll" class="w-4 h-4 text-amber-600"></i> 
                                å¦è±¡æ•¸ç†
                            </h3>
                            <div id="log-container" class="space-y-3"></div>
                            
                            <!-- Static Description -->
                            <div id="static-desc" class="mt-4 pt-4 border-t border-stone-100 text-stone-600 text-sm leading-relaxed"></div>
                        </div>
                    </div>
                </div>

                <!-- AI Analysis Area -->
                <div class="p-8 bg-white min-h-[300px] relative z-10">
                    <div id="ai-loading" class="flex flex-col items-center justify-center py-10 space-y-6">
                        <div class="relative w-16 h-16">
                            <div class="absolute inset-0 border-4 border-stone-100 rounded-full"></div>
                            <div class="absolute inset-0 border-4 border-amber-600 rounded-full border-t-transparent animate-spin"></div>
                            <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-stone-400">AI</div>
                        </div>
                        <p class="text-stone-500 animate-pulse tracking-widest text-sm">Google AI æ­£åœ¨è§£æå¤©æ©Ÿ...</p>
                    </div>
                    
                    <div id="ai-content" class="hidden space-y-5 text-stone-700 leading-loose text-justify"></div>
                </div>
                
                <div class="bg-stone-900 text-stone-400 text-[10px] p-2 text-center relative z-10">
                    AI æ˜“ç¶“å‘½ç†å¤§å¸« Â· é›²ç«¯è§£æƒ‘
                </div>
            </div>
            <!-- Capture Area End -->

            <!-- Actions Bar (Download) -->
             <div class="flex gap-3 justify-center mb-6">
                 <button onclick="downloadResultImage()" class="px-6 py-2 bg-amber-600 text-white rounded-full font-bold shadow-lg hover:bg-amber-700 transition flex items-center gap-2">
                    <i data-lucide="download" class="w-4 h-4"></i> ä¸‹è¼‰æ”¶è—
                </button>
             </div>

            <!-- Feedback Section -->
            <div id="feedback-section" class="hidden p-6 bg-amber-50 rounded-xl border border-amber-100 mb-6">
                <h3 class="text-center font-bold text-stone-700 mb-3">æ‚¨å°é€™æ¬¡çš„è§£ææ»¿æ„å—ï¼Ÿ</h3>
                <div class="flex justify-center gap-2 mb-2">
                    <button onclick="rateService(1)" class="star-btn text-3xl grayscale hover:grayscale-0 hover:scale-110 transition p-1" data-val="1">ğŸ˜¡</button>
                    <button onclick="rateService(2)" class="star-btn text-3xl grayscale hover:grayscale-0 hover:scale-110 transition p-1" data-val="2">ğŸ˜•</button>
                    <button onclick="rateService(3)" class="star-btn text-3xl grayscale hover:grayscale-0 hover:scale-110 transition p-1" data-val="3">ğŸ˜</button>
                    <button onclick="rateService(4)" class="star-btn text-3xl grayscale hover:grayscale-0 hover:scale-110 transition p-1" data-val="4">ğŸ™‚</button>
                    <button onclick="rateService(5)" class="star-btn text-3xl grayscale hover:grayscale-0 hover:scale-110 transition p-1" data-val="5">ğŸ˜</button>
                </div>
                <!-- Instant Save Message -->
                <div id="rating-saved-msg" class="text-center text-xs text-green-600 font-bold h-4 mb-2 opacity-0 transition-opacity">
                    âœ“ å·²å„²å­˜è©•åˆ†
                </div>
                
                <div id="feedback-form" class="hidden space-y-3 animate-fade-in">
                     <textarea id="feedback-text" placeholder="è£œå……å›é¥‹ï¼šæ‚¨è¦ºå¾—æº–ç¢ºå—ï¼Ÿé‚„æœ‰ä»€éº¼å»ºè­°ï¼Ÿ" class="w-full p-3 rounded border border-stone-200 text-sm focus:ring-1 focus:ring-amber-500 outline-none"></textarea>
                     <button onclick="submitFeedbackText()" class="w-full py-2 bg-stone-700 text-white rounded text-sm hover:bg-stone-600">é€å‡ºè£œå……å›é¥‹</button>
                </div>
                <div id="feedback-thanks" class="hidden text-center text-stone-500 text-sm py-2">æ„Ÿè¬æ‚¨çš„å¯¶è²´æ„è¦‹ï¼</div>
            </div>

            <!-- Footer Action -->
            <div class="flex justify-center gap-4 text-center">
                 <button onclick="resetApp('view-cover')" class="px-6 py-3 bg-stone-100 border border-stone-300 hover:bg-stone-200 text-stone-600 rounded-lg transition-colors inline-flex items-center gap-2 shadow-sm">
                    <i data-lucide="home" class="w-4 h-4"></i> è¿”å›é¦–é 
                </button>
                 <button onclick="resetApp('view-input')" class="px-8 py-3 bg-white border border-stone-300 hover:bg-stone-100 text-stone-700 rounded-lg transition-colors inline-flex items-center gap-2 shadow-sm">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> å†å•ä¸€äº‹
                </button>
            </div>
        </div>

        <!-- View 4: Admin Login Modal -->
        <div id="admin-login-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center fade-in">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-80 text-center">
                <h3 class="font-bold text-stone-800 mb-4 text-lg">ç®¡ç†å“¡ç™»å…¥</h3>
                <input type="password" id="admin-pwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="w-full p-2 border border-stone-300 rounded mb-4 text-center tracking-widest">
                <div class="flex gap-2">
                    <button onclick="closeAdminLogin()" class="flex-1 py-2 bg-stone-200 rounded text-stone-600">å–æ¶ˆ</button>
                    <button onclick="checkAdminLogin()" class="flex-1 py-2 bg-stone-800 text-white rounded">ç¢ºèª</button>
                </div>
            </div>
        </div>

        <!-- View 5: Admin Dashboard -->
        <div id="view-admin" class="hidden fade-in w-full max-w-5xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-stone-800">ğŸ”® å‘½ç†æœå‹™å¾Œå°</h2>
                <button onclick="exitAdmin()" class="px-4 py-2 bg-stone-200 rounded hover:bg-stone-300 flex items-center gap-2">
                    <i data-lucide="log-out" class="w-4 h-4"></i> ç™»å‡º
                </button>
            </div>

            <div class="bg-white rounded-xl shadow border border-stone-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm whitespace-nowrap">
                        <thead class="bg-stone-100 text-stone-600 font-bold border-b border-stone-200">
                            <tr>
                                <th class="p-4">æ™‚é–“</th>
                                <th class="p-4">ä½¿ç”¨è€…</th>
                                <th class="p-4 w-1/3 min-w-[200px]">å•é¡Œ</th>
                                <th class="p-4">å¦è±¡</th>
                                <th class="p-4 text-center">æ»¿æ„åº¦</th>
                                <th class="p-4">åŠŸèƒ½</th>
                            </tr>
                        </thead>
                        <tbody id="admin-table-body" class="divide-y divide-stone-100">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>
                <div id="admin-loading" class="p-8 text-center text-stone-500">æ­£åœ¨è¼‰å…¥è³‡æ–™...</div>
            </div>
        </div>

        <!-- Detail Modal (Shared by Admin & History) -->
        <div id="detail-modal" class="hidden fixed inset-0 bg-black/70 z-[60] flex items-center justify-center fade-in p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden relative">
                <button onclick="closeDetailModal()" class="absolute top-4 right-4 p-2 bg-stone-100 rounded-full hover:bg-stone-200 z-10">
                    <i data-lucide="x" class="w-5 h-5 text-stone-600"></i>
                </button>

                <div class="overflow-y-auto p-8 custom-scrollbar">
                    <h3 class="text-xl font-bold text-stone-800 mb-6 flex items-center gap-2 border-b border-stone-200 pb-4">
                        <i data-lucide="file-text" class="w-5 h-5 text-amber-600"></i> ç´€éŒ„è©³æƒ…
                    </h3>
                    
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-4 text-sm bg-stone-50 p-4 rounded-lg">
                            <div><span class="text-stone-500">æ™‚é–“ï¼š</span><span id="detail-time" class="font-bold"></span></div>
                            <div><span class="text-stone-500">æ±‚åœè€…ï¼š</span><span id="detail-user" class="font-bold"></span></div>
                            <div class="col-span-2"><span class="text-stone-500">å•é¡Œï¼š</span><p id="detail-question" class="font-bold text-lg mt-1"></p></div>
                        </div>

                        <div class="flex items-center gap-4 bg-stone-50 p-4 rounded-lg border-l-4 border-amber-600">
                            <div class="text-3xl font-serif text-stone-800" id="detail-hex-name"></div>
                            <div class="text-stone-500 text-sm flex-1" id="detail-hex-nums"></div>
                        </div>

                        <div>
                            <h4 class="font-bold text-stone-700 mb-2">AI å®Œæ•´è§£æ</h4>
                            <div id="detail-analysis" class="text-stone-600 leading-loose text-justify text-sm p-4 border border-stone-100 rounded-lg"></div>
                        </div>

                        <div class="border-t border-stone-100 pt-4 mt-4">
                            <h4 class="font-bold text-stone-700 mb-2">å›é¥‹ç´€éŒ„</h4>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-stone-500 text-sm">è©•åˆ†ï¼š</span>
                                <span id="detail-rating"></span>
                            </div>
                            <div class="bg-amber-50 p-3 rounded text-sm text-stone-600 italic">
                                <span class="text-stone-400 not-italic">ç•™è¨€ï¼š</span> <span id="detail-feedback"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- View 6: User History Search -->
        <div id="view-history" class="hidden fade-in w-full max-w-2xl">
            <div class="bg-white rounded-xl shadow-xl border border-stone-200 p-6 min-h-[400px]">
                <div class="flex justify-between items-center mb-6 pb-4 border-b border-stone-100">
                    <h2 class="text-xl font-bold text-stone-800 flex items-center gap-2">
                        <i data-lucide="history" class="w-5 h-5 text-amber-600"></i>
                        æˆ‘çš„æ­·å²ç´€éŒ„
                    </h2>
                    <button onclick="switchView('view-cover')" class="p-2 hover:bg-stone-100 rounded-full text-stone-400 hover:text-stone-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>

                <div class="flex flex-col gap-3 mb-6">
                    <input type="text" id="history-search-name" placeholder="è«‹è¼¸å…¥æ±‚åœæ™‚çš„å§“å" class="p-3 bg-stone-50 border border-stone-200 rounded-lg outline-none focus:ring-2 focus:ring-amber-500/50">
                    <div class="flex gap-2">
                        <input type="password" id="history-search-pwd" placeholder="è«‹è¼¸å…¥æŸ¥è©¢å¯†ç¢¼ (è‹¥ç„¡è¨­å®šå¯ç•™ç©º)" class="flex-1 p-3 bg-stone-50 border border-stone-200 rounded-lg outline-none focus:ring-2 focus:ring-amber-500/50">
                        <button onclick="searchHistory()" class="px-6 bg-stone-800 text-white rounded-lg font-bold hover:bg-stone-700 w-24">æŸ¥è©¢</button>
                    </div>
                    <p class="text-xs text-stone-400">â€» å¿˜è¨˜å¯†ç¢¼è«‹è¯ç¹«ç®¡ç†å“¡</p>
                </div>

                <div id="history-loading" class="hidden text-center py-10 text-stone-400">
                    <i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto mb-2"></i>
                    æŸ¥è©¢ä¸­...
                </div>

                <div id="history-list" class="space-y-4">
                    <div class="text-center py-10 text-stone-400 text-sm">
                        è¼¸å…¥è³‡æ–™å¾Œé–‹å§‹æŸ¥è©¢
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Application Logic -->
    <script>
        // --- 1. Constants & Data ---
        const TRIGRAMS = {
            1: { name: 'ä¹¾', nature: 'å¤©', image: 'â˜°', meaning: 'å‰›å¥', element: 'é‡‘' },
            2: { name: 'å…Œ', nature: 'æ¾¤', image: 'â˜±', meaning: 'å–œæ‚…', element: 'é‡‘' },
            3: { name: 'é›¢', nature: 'ç«', image: 'â˜²', meaning: 'ä¾é™„', element: 'ç«' },
            4: { name: 'éœ‡', nature: 'é›·', image: 'â˜³', meaning: 'éœ‡å‹•', element: 'æœ¨' },
            5: { name: 'å·½', nature: 'é¢¨', image: 'â˜´', meaning: 'é€²å…¥', element: 'æœ¨' },
            6: { name: 'å', nature: 'æ°´', image: 'â˜µ', meaning: 'éšªé™·', element: 'æ°´' },
            7: { name: 'è‰®', nature: 'å±±', image: 'â˜¶', meaning: 'åœæ­¢', element: 'åœŸ' },
            8: { name: 'å¤', nature: 'åœ°', image: 'â˜·', meaning: 'æŸ”é †', element: 'åœŸ' },
        };

        const HEXAGRAM_DATA_FALLBACK = {
            "1-1": { name: "ä¹¾ç‚ºå¤©", sentiment: "å¤§å‰", desc: "é›™é¾å‡ºæµ·ï¼Œå‰›å¥ä¸­æ­£ã€‚ç›®å‰é‹å‹¢æ¥µå¼·ï¼Œä½†ä¹Ÿéœ€æ³¨æ„å‰›éæ˜“æŠ˜ï¼Œå®œæ­£é“è€Œè¡Œã€‚" },
            "8-8": { name: "å¤ç‚ºåœ°", sentiment: "å‰", desc: "åšå¾·è¼‰ç‰©ï¼ŒåŒ…å®¹è¬è±¡ã€‚é‹å‹¢å¹³ç©©ï¼Œå®œå®ˆä¸å®œæ”»ï¼Œé †å‹¢è€Œç‚ºå¯ç²ç›Šã€‚" },
            // Keeping it short
        };

        const generateGenericInterpretation = (upper, lower) => {
          const natureUpper = TRIGRAMS[upper].nature;
          const natureLower = TRIGRAMS[lower].nature;
          const meaningUpper = TRIGRAMS[upper].meaning;
          const meaningLower = TRIGRAMS[lower].meaning;
          
          return {
            name: `${natureUpper}${natureLower}å¦`,
            sentiment: "ä¸­å¹³",
            desc: `ä¸Š${natureUpper}ä¸‹${natureLower}ã€‚å¤–åœ¨è¡¨ç¾ç‚º${meaningUpper}ï¼Œå…§åœ¨åŸºç¤ç‚º${meaningLower}ã€‚${TRIGRAMS[upper].element}èˆ‡${TRIGRAMS[lower].element}ç›¸é‡ï¼Œéœ€è§€å¯Ÿå…©è€…å±¬æ€§æ˜¯å¦ç›¸ç”Ÿç›¸å‰‹ä¾†åˆ¤æ–·å‰å‡¶ã€‚å»ºè­°å¯©æ™‚åº¦å‹¢ã€‚`
          };
        };

        // --- 2. State ---
        let state = {
            step: 'cover',
            question: '',
            name: '',
            password: '', // New password field
            gender: 'ç”·',
            age: '',
            numbers: [null, null, null],
            flipIndex: 0,
            animationInterval: null,
            user: null,
            currentDocId: null 
        };

        let loadedDataCache = {};

        // --- 3. Firebase Setup ---
        const userFirebaseConfig = {
            apiKey: "AIzaSyDSxmYDpme-iQgiNScEl10dKjYsK2ZX0vs",
            authDomain: "livetest-9c9ba.firebaseapp.com",
            projectId: "livetest-9c9ba",
            storageBucket: "livetest-9c9ba.firebasestorage.app",
            messagingSenderId: "362928232271",
            appId: "1:362928232271:web:4923443483a575c89c173a",
            measurementId: "G-D3JPLWXV0Z"
        };

        const configToUse = (typeof __firebase_config !== 'undefined' && __firebase_config) 
                            ? JSON.parse(__firebase_config) 
                            : userFirebaseConfig;

        const app = firebase.initializeApp(configToUse);
        if (typeof firebase.analytics === 'function') {
            firebase.analytics();
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        async function initAuth() {
            auth.onAuthStateChanged((user) => {
                state.user = user;
            });
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
            } catch (error) {
                console.error("Auth Error:", error);
            }
        }
        initAuth();

        // --- 4. UI Functions ---

        lucide.createIcons();

        function switchView(viewId) {
            ['view-cover', 'view-input', 'view-meditating', 'view-result', 'view-admin', 'view-history'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
            lucide.createIcons();
            window.scrollTo(0, 0);
        }

        function enterApp() {
            switchView('view-input');
        }

        function showHistorySearch() {
            switchView('view-history');
        }

        // Input Handling
        function startDivination() {
            const questionVal = document.getElementById('question-input').value.trim();
            const nameVal = document.getElementById('user-name').value.trim();
            const pwdVal = document.getElementById('user-password').value.trim();
            const genderVal = document.getElementById('user-gender').value;
            const ageVal = document.getElementById('user-age').value;

            // Name is now required for history tracking
            if (!nameVal) {
                alert("è«‹è¼¸å…¥æ‚¨çš„å§“åæˆ–æš±ç¨±ï¼Œä»¥ä¾¿æ—¥å¾ŒæŸ¥è©¢ç´€éŒ„");
                document.getElementById('user-name').focus();
                return;
            }

            if (!questionVal) {
                const input = document.getElementById('question-input');
                input.classList.add('animate-shake', 'ring-2', 'ring-red-400');
                input.focus();
                setTimeout(() => {
                    input.classList.remove('animate-shake', 'ring-2', 'ring-red-400');
                }, 500);
                return;
            }

            state.question = questionVal;
            state.name = nameVal; 
            state.password = pwdVal; // Store password
            state.gender = genderVal;
            state.age = ageVal;

            state.step = 'meditating';
            state.numbers = [null, null, null];
            state.flipIndex = 0;
            switchView('view-meditating');
            renderNumbers();
            startNumberAnimation();
            document.getElementById('flip-hint').classList.remove('hidden');
        }

        function renderNumbers() {
            const container = document.getElementById('numbers-container');
            container.innerHTML = '';
            
            [0, 1, 2].forEach(idx => {
                const label = idx === 0 ? 'ä¸Šå¦' : idx === 1 ? 'ä¸‹å¦' : 'è®Šçˆ»';
                const isCurrent = idx === state.flipIndex;
                const hasValue = state.numbers[idx] !== null;
                
                let contentHTML = `<div class="text-stone-300 text-3xl font-serif">?</div>`;
                let boxClass = 'book-page border border-stone-200 opacity-60';

                if (hasValue) {
                    contentHTML = `
                        <div class="text-xs text-stone-400 mb-1">ç¬¬</div>
                        <div class="text-4xl font-bold font-serif text-stone-800">${state.numbers[idx]}</div>
                        <div class="text-xs text-stone-400 mt-1">é </div>
                    `;
                    boxClass = 'book-page border-l-4 border-l-amber-600 border-t border-r border-b border-stone-200 transform scale-100 shadow-md';
                } else if (isCurrent) {
                    contentHTML = `
                         <div class="text-xs text-stone-300 mb-1">ç¿»é </div>
                         <div id="anim-num-${idx}" class="text-3xl font-bold font-serif text-stone-300 blur-[1px]">...</div>
                    `; 
                    boxClass = 'book-page border border-amber-300 transform scale-105 shadow-xl z-10';
                }

                const html = `
                    <div class="flex flex-col items-center gap-3">
                        <div id="num-box-${idx}" class="w-24 h-36 rounded-sm flex flex-col items-center justify-center transition-all duration-300 ${boxClass}">
                            ${contentHTML}
                        </div>
                        <span class="text-xs font-bold text-stone-500 uppercase tracking-widest bg-stone-100 px-2 py-1 rounded">${label}</span>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function startNumberAnimation() {
            if (state.animationInterval) clearInterval(state.animationInterval);
            state.animationInterval = setInterval(() => {
                if (state.flipIndex <= 2) {
                    const el = document.getElementById(`anim-num-${state.flipIndex}`);
                    if (el) {
                        el.innerText = Math.floor(Math.random() * 500) + 1;
                    }
                }
            }, 40);
        }

        function flipPage() {
            const num = Math.floor(Math.random() * 500) + 1;
            state.numbers[state.flipIndex] = num;
            
            if (state.flipIndex < 2) {
                state.flipIndex++;
                const btnText = document.getElementById('flip-btn-text');
                const nextAction = state.flipIndex === 1 ? "ç¬¬äºŒ" : "è®Šçˆ»";
                btnText.innerText = `ç¿»é–‹${nextAction}é `;
                renderNumbers();
            } else {
                renderNumbers();
                clearInterval(state.animationInterval);
                const btn = document.getElementById('flip-btn');
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                document.getElementById('flip-btn-text').innerText = "æ­£åœ¨è§£è®€å¦è±¡...";
                document.getElementById('flip-hint').innerText = "å¤©å‚è±¡ï¼Œè¦‹å‰å‡¶...";
                
                setTimeout(() => {
                    calculateResult();
                }, 1500);
            }
        }

        // --- 5. Calculation & AI Logic ---

        async function calculateResult() {
            const n1 = state.numbers[0];
            const n2 = state.numbers[1];
            const n3 = state.numbers[2];

            const upperId = n1 % 8 === 0 ? 8 : n1 % 8;
            const lowerId = n2 % 8 === 0 ? 8 : n2 % 8;
            const changeLine = n3 % 6 === 0 ? 6 : n3 % 6;

            const upper = TRIGRAMS[upperId];
            const lower = TRIGRAMS[lowerId];
            
            const key = `${upperId}-${lowerId}`;
            const basicInfo = HEXAGRAM_DATA_FALLBACK[key] || generateGenericInterpretation(upperId, lowerId);

            document.getElementById('result-question').innerText = state.question;
            document.getElementById('result-user-info').innerText = `${state.name} / ${state.gender} / ${state.age ? state.age + 'æ­²' : 'å¹´é½¡ä¿å¯†'}`;
            document.getElementById('result-hex-name').innerText = basicInfo.name;
            document.getElementById('result-sentiment').innerText = `ã€${basicInfo.sentiment}ã€‘`;
            
            document.getElementById('upper-img').innerText = upper.image;
            document.getElementById('upper-name').innerText = `ä¸Šå¦ Â· ${upper.name} (${upper.nature})`;
            
            document.getElementById('lower-img').innerText = lower.image;
            document.getElementById('lower-name').innerText = `ä¸‹å¦ Â· ${lower.name} (${lower.nature})`;

            const logHTML = `
                <div class="flex justify-between items-center border-b border-stone-100 pb-2 text-sm">
                    <span class="text-stone-500">ç¬¬ ${n1} é </span>
                    <i data-lucide="arrow-right" class="w-3 h-3 text-stone-300"></i>
                    <span class="font-bold text-stone-700">é¤˜ ${upperId} ç‚º ${upper.name}</span>
                </div>
                <div class="flex justify-between items-center border-b border-stone-100 pb-2 text-sm">
                    <span class="text-stone-500">ç¬¬ ${n2} é </span>
                    <i data-lucide="arrow-right" class="w-3 h-3 text-stone-300"></i>
                    <span class="font-bold text-stone-700">é¤˜ ${lowerId} ç‚º ${lower.name}</span>
                </div>
                <div class="flex justify-between items-center text-sm">
                    <span class="text-stone-500">ç¬¬ ${n3} é </span>
                    <i data-lucide="arrow-right" class="w-3 h-3 text-stone-300"></i>
                    <span class="font-bold text-amber-700">é¤˜ ${changeLine} ç‚º è®Šçˆ»</span>
                </div>
            `;
            document.getElementById('log-container').innerHTML = logHTML;
            document.getElementById('static-desc').innerText = basicInfo.desc;

            // Show feedback section
            document.getElementById('feedback-section').classList.remove('hidden');
            
            switchView('view-result');
            lucide.createIcons();

            await fetchAIInterpretation(upper, lower, changeLine, basicInfo.name);
        }

        async function fetchAIInterpretation(upper, lower, changeLine, hexName) {
            const aiLoading = document.getElementById('ai-loading');
            const aiContent = document.getElementById('ai-content');
            
            const promptText = `
                ä½ æ˜¯ä¸€ä½ç²¾é€šæ˜“ç¶“ã€èªæ°£æº«æŸ”ä¸”æœ‰æ™ºæ…§çš„å‘½ç†å¤§å¸«ã€‚
                æ±‚åœè€…è³‡è¨Šï¼šå§“åã€${state.name}ã€‘ï¼Œæ€§åˆ¥ã€${state.gender}ã€‘ï¼Œå¹´é½¡ã€${state.age || 'æœªå¡«å¯«'}ã€‘ã€‚
                æ±‚åœè€…å•ï¼šã€Œ${state.question}ã€ã€‚
                ç¿»æ›¸æ±‚å¾—ï¼š
                - æœ¬å¦ï¼š${hexName} (ä¸Š${upper.nature}ä¸‹${lower.nature})ã€‚
                - è®Šçˆ»ï¼šç¬¬ ${changeLine} çˆ»ã€‚
                
                è«‹åšä»¥ä¸‹åˆ†æï¼Œä½¿ç”¨HTMLæ ¼å¼ (ä¸è¦Markdown code blockï¼Œç›´æ¥çµ¦ <p> ç­‰æ¨™ç±¤)ï¼š
                1. <p><strong>ã€å¦è±¡æ„æ¶µã€‘</strong>ç°¡è¿°${upper.nature}${lower.nature}çš„è‡ªç„¶æ„è±¡èˆ‡å“²ç†ã€‚</p>
                2. <p><strong>ã€å…¸ç±æ•…äº‹ã€‘</strong>å¼•ç”¨ä¸€å€‹èˆ‡æ­¤å¦è±¡ç›¸é—œçš„æ­·å²å…¸æ•…ã€æ˜“ç¶“æ•…äº‹æˆ–æ­·å²äººç‰©ç¶“æ­·ï¼ˆä¾‹å¦‚å‘¨æ–‡ç‹ã€å­”å­ã€æ­·å²åå°‡ç­‰ï¼‰ï¼Œç”¨ä»¥è¼”åŠ©èªªæ˜æ­¤å¦çš„æ„å¢ƒã€‚</p>
                3. <p><strong>ã€é‹å‹¢è§£è®€ã€‘</strong>çµåˆæ±‚åœè€…çš„å¹´é½¡èˆ‡æ€§åˆ¥èƒŒæ™¯ï¼Œé‡å°å•é¡Œã€Œ${state.question}ã€ç›´æŒ‡æ ¸å¿ƒåˆ¤æ–·å‰å‡¶ã€‚</p>
                4. <div class="bg-stone-50 p-5 rounded border-l-4 border-amber-600 mt-4 text-stone-800"><p class="font-bold text-amber-800 mb-2 text-lg">å¤§å¸«æŒ‡å¼•ï¼š</p><p>çµåˆè®Šçˆ»å«ç¾©ï¼Œçµ¦äºˆä¸€æ®µå…·é«”ã€æœ‰ç¦ªæ„ä½†å¯åŸ·è¡Œçš„å»ºè­°ã€‚</p></div>
                
                èªæ°£è«‹ä¿æŒå¤é¢¨ä½†ä¸éæ–¼è‰±æ¾€ï¼Œå­—æ•¸ç´„ 500 å­—ã€‚
            `;

            try {
                const apiKey = "AIzaSyBxhqrv0en1iI7XrfT3cjh3f2xFj2WQT7Y"; 
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                const safetySettings = [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_ONLY_HIGH" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" }
                ];

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: promptText }] }],
                        safetySettings: safetySettings
                    })
                });

                const data = await response.json();
                
                let aiText = "å¤§å¸«æ­£åœ¨å†¥æƒ³ä¸­...";
                if (data && data.candidates && data.candidates[0].content) {
                    aiText = data.candidates[0].content.parts[0].text;
                } else {
                    aiText = "<p>å¤©æ©Ÿä¸å¯æ´©éœ²ï¼Œè«‹åƒè€ƒä¸Šæ–¹å¦è±¡æ„æ¶µè‡ªè¡Œé«”æ‚Ÿã€‚</p>";
                }
                
                aiText = aiText.replace(/```html/g, '').replace(/```/g, '');

                aiLoading.classList.add('hidden');
                aiContent.innerHTML = aiText;
                aiContent.classList.remove('hidden');

                saveToFirestore(hexName, aiText);

            } catch (error) {
                console.error("AI Error:", error);
                aiLoading.innerHTML = `<p class="text-stone-400 text-center">é›²ç«¯å¤©æ©Ÿæš«æ™‚ç„¡æ³•é€£ç·šï¼Œè«‹åƒè€ƒä¸Šæ–¹å¦è±¡æ•¸ç†ã€‚</p>`;
            }
        }

        async function saveToFirestore(hexName, aiResult) {
            if (!state.user) return;
            try {
                const collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('readings');
                
                const docRef = await collectionRef.add({
                    userInfo: {
                        name: state.name,
                        gender: state.gender,
                        age: state.age
                    },
                    question: state.question,
                    numbers: state.numbers,
                    password: state.password, // Save Password
                    hexagram: hexName,
                    aiAnalysis: aiResult, 
                    rating: null,
                    feedback: null,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                state.currentDocId = docRef.id;

            } catch (e) {
                console.error("Save Error:", e);
            }
        }

        // --- 6. Feedback System ---
        let currentRating = 0;
        
        async function rateService(val) {
            currentRating = val;
            document.querySelectorAll('.star-btn').forEach(btn => {
                if(parseInt(btn.dataset.val) <= val) {
                    btn.classList.remove('grayscale');
                } else {
                    btn.classList.add('grayscale');
                }
            });
            document.getElementById('feedback-form').classList.remove('hidden');
            const msg = document.getElementById('rating-saved-msg');
            msg.style.opacity = '1';
            setTimeout(() => { msg.style.opacity = '0'; }, 3000);

            if (state.currentDocId) {
                try {
                    const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('readings').doc(state.currentDocId);
                    await docRef.update({ rating: currentRating });
                } catch(e) { console.error(e); }
            }
        }

        async function submitFeedbackText() {
            if (!state.currentDocId) return;
            const text = document.getElementById('feedback-text').value;
            try {
                const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('readings').doc(state.currentDocId);
                await docRef.update({ feedback: text });
                document.getElementById('feedback-form').classList.add('hidden');
                document.getElementById('feedback-thanks').classList.remove('hidden');
            } catch(e) { console.error(e); }
        }

        // --- 7. Download Image ---
        function downloadResultImage() {
            const captureArea = document.getElementById('result-capture-area');
            html2canvas(captureArea, {
                scale: 2, backgroundColor: "#ffffff", useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `æ˜“ç¶“è§£æƒ‘_${state.name}_${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }).catch(err => {
                alert("åœ–ç‰‡ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            });
        }

        // --- 8. History Search Logic (with Password) ---
        async function searchHistory() {
            const name = document.getElementById('history-search-name').value.trim();
            const pwd = document.getElementById('history-search-pwd').value.trim();
            const listContainer = document.getElementById('history-list');
            const loading = document.getElementById('history-loading');
            
            if (!name) {
                alert("è«‹è¼¸å…¥å§“å");
                return;
            }

            listContainer.innerHTML = '';
            loading.classList.remove('hidden');
            loadedDataCache = {}; // Reset cache

            try {
                const collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('readings');
                // Use Name filter + Order by time
                const snapshot = await collectionRef.where('userInfo.name', '==', name).orderBy('timestamp', 'desc').get();
                
                loading.classList.add('hidden');
                
                // Client-side Password Filtering
                const masterKey = 'kaiyu';
                const validDocs = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    // If stored pwd exists, require matching input OR master key
                    // If no stored pwd (old records), allow access
                    if (!data.password || data.password === pwd || pwd === masterKey) {
                        validDocs.push({ id: doc.id, data: data });
                    }
                });

                if (validDocs.length === 0) {
                    listContainer.innerHTML = `<div class="text-center py-8 text-stone-400">æ‰¾ä¸åˆ°ã€Œ${name}ã€çš„ç´€éŒ„ï¼Œæˆ–æ˜¯å¯†ç¢¼éŒ¯èª¤ã€‚</div>`;
                    return;
                }

                validDocs.forEach(item => {
                    const docId = item.id;
                    const data = item.data;
                    loadedDataCache[docId] = data; // Cache for modal

                    // Robust Date Formatting
                    let dateStr = "å‰›å‰›";
                    if (data.timestamp) {
                        try {
                            const dateObj = data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp);
                            if (!isNaN(dateObj.getTime())) {
                                dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            }
                        } catch(e) {}
                    }

                    const card = document.createElement('div');
                    card.className = "bg-stone-50 p-4 rounded-lg border border-stone-200 hover:shadow-md transition cursor-pointer";
                    card.onclick = function() { openDetailModal(docId); };
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs text-stone-400">${dateStr}</span>
                            <span class="text-sm font-bold text-amber-700">${data.hexagram}</span>
                        </div>
                        <h4 class="font-bold text-stone-800 mb-2">${data.question}</h4>
                        <div class="text-xs text-stone-500 line-clamp-2 leading-relaxed">
                            ${data.aiAnalysis ? data.aiAnalysis.replace(/<[^>]*>/g, '').substring(0, 60) + '...' : 'ï¼ˆç„¡è©³ç´°åˆ†æï¼‰'}
                        </div>
                        <div class="mt-2 text-right">
                            <span class="text-xs text-amber-600 font-bold border border-amber-200 px-2 py-1 rounded hover:bg-amber-50 flex inline-flex items-center gap-1 justify-end">
                                <i data-lucide="eye" class="w-3 h-3"></i> æŸ¥çœ‹è©³æƒ…
                            </span>
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
                lucide.createIcons();

            } catch (err) {
                console.error("History Error:", err);
                loading.classList.add('hidden');
                
                if (err.message && err.message.includes("requires an index")) {
                     // Fallback for missing index
                     try {
                        const allSnap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('readings').orderBy('timestamp', 'desc').limit(100).get();
                        const validDocs = [];
                        const masterKey = 'kaiyu';

                        allSnap.forEach(doc => {
                            const data = doc.data();
                            if (data.userInfo?.name === name) {
                                if (!data.password || data.password === pwd || pwd === masterKey) {
                                    validDocs.push({ id: doc.id, data: data });
                                }
                            }
                        });
                        
                        if (validDocs.length === 0) {
                            listContainer.innerHTML = `<div class="text-center py-8 text-stone-400">æ‰¾ä¸åˆ°ç´€éŒ„æˆ–å¯†ç¢¼éŒ¯èª¤</div>`;
                            return;
                        }
                        
                        validDocs.forEach(item => {
                            // Same render logic...
                            const docId = item.id;
                            const data = item.data;
                            loadedDataCache[docId] = data;
                            let dateStr = "æœªçŸ¥æ—¥æœŸ";
                            if (data.timestamp) { try { dateStr = (data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp)).toLocaleDateString(); } catch(e){} }
                            
                            const card = document.createElement('div');
                            card.className = "bg-stone-50 p-4 rounded-lg border border-stone-200 hover:shadow-md transition cursor-pointer";
                            card.onclick = function() { openDetailModal(docId); };
                            card.innerHTML = `
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-xs text-stone-400">${dateStr}</span>
                                    <span class="text-sm font-bold text-amber-700">${data.hexagram}</span>
                                </div>
                                <h4 class="font-bold text-stone-800 mb-2">${data.question}</h4>
                                <div class="mt-2 text-right">
                                    <span class="text-xs text-amber-600 font-bold px-2 py-1 rounded border border-amber-200">æŸ¥çœ‹è©³æƒ…</span>
                                </div>`;
                            listContainer.appendChild(card);
                        });
                     } catch (e) {
                         listContainer.innerHTML = `<div class="text-center py-8 text-red-400">ç³»çµ±ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦</div>`;
                     }
                } else {
                    listContainer.innerHTML = `<div class="text-center py-8 text-red-400">æŸ¥è©¢å¤±æ•—</div>`;
                }
            }
        }

        // --- 9. Admin Logic ---
        function showAdminLogin() {
            document.getElementById('admin-login-modal').classList.remove('hidden');
        }
        
        function closeAdminLogin() {
            document.getElementById('admin-login-modal').classList.add('hidden');
            document.getElementById('admin-pwd').value = '';
        }
        
        function checkAdminLogin() {
            const pwd = document.getElementById('admin-pwd').value;
            if (pwd === '8888') {
                closeAdminLogin();
                loadAdminData();
                switchView('view-admin');
            } else {
                alert('å¯†ç¢¼éŒ¯èª¤');
            }
        }
        
        function exitAdmin() {
            switchView('view-cover');
        }

        async function loadAdminData() {
            const tbody = document.getElementById('admin-table-body');
            tbody.innerHTML = '';
            document.getElementById('admin-loading').classList.remove('hidden');
            loadedDataCache = {};

            try {
                const collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('readings');
                const querySnapshot = await collectionRef.orderBy('timestamp', 'desc').limit(50).get();
                
                document.getElementById('admin-loading').classList.add('hidden');
                
                if (querySnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-stone-400">å°šç„¡è³‡æ–™</td></tr>';
                    return;
                }

                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    loadedDataCache[doc.id] = data;

                    // Robust Date
                    let dateStr = 'N/A';
                    if (data.timestamp) {
                        try {
                            const d = data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp);
                            if(!isNaN(d.getTime())) dateStr = d.toLocaleString('zh-TW');
                        } catch(e) {}
                    }

                    const userStr = `${data.userInfo?.name || 'åŒ¿å'} (${data.userInfo?.gender || '-'})`;
                    const ratingStr = data.rating ? 'â­'.repeat(data.rating) : '<span class="text-gray-300">-</span>';
                    
                    const row = `
                        <tr class="hover:bg-stone-50 transition">
                            <td class="p-4 text-xs text-stone-500 whitespace-normal w-24">${dateStr}</td>
                            <td class="p-4 font-bold text-stone-700">${userStr}</td>
                            <td class="p-4"><div class="line-clamp-2 w-full max-w-xs" title="${data.question}">${data.question}</div></td>
                            <td class="p-4 text-amber-700 font-serif font-bold">${data.hexagram || '-'}</td>
                            <td class="p-4 text-center text-xs">${ratingStr}</td>
                            <td class="p-4">
                                <button onclick="openDetailModal('${doc.id}')" class="bg-white border border-stone-300 hover:bg-stone-100 text-stone-600 px-3 py-1 rounded text-xs flex items-center gap-1 transition shadow-sm">
                                    <i data-lucide="search" class="w-3 h-3"></i> æŸ¥çœ‹
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                lucide.createIcons();

            } catch (e) {
                console.error(e);
                document.getElementById('admin-loading').innerHTML = '<span class="text-red-400">è¼‰å…¥å¤±æ•—</span>';
            }
        }

        // --- 10. Shared Detail Modal ---
        function openDetailModal(docId) {
            const data = loadedDataCache[docId];
            if (!data) return;

            // Date
            let dateStr = 'æ™‚é–“æœªè¨˜éŒ„';
            if (data.timestamp) {
                try {
                    const d = data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp);
                    if(!isNaN(d.getTime())) dateStr = d.toLocaleString('zh-TW');
                } catch(e){}
            }
            
            document.getElementById('detail-time').innerText = dateStr;
            document.getElementById('detail-user').innerText = `${data.userInfo?.name || 'åŒ¿å'} (${data.userInfo?.gender || '-'} / ${data.userInfo?.age || '?'}æ­²)`;
            document.getElementById('detail-question').innerText = data.question;
            document.getElementById('detail-hex-name').innerText = data.hexagram;
            
            if (data.numbers && data.numbers.length === 3) {
                document.getElementById('detail-hex-nums').innerText = `éˆæ•¸ï¼š[${data.numbers[0]}, ${data.numbers[1]}, ${data.numbers[2]}]`;
            } else {
                document.getElementById('detail-hex-nums').innerText = '';
            }

            document.getElementById('detail-analysis').innerHTML = data.aiAnalysis || '<p class="text-gray-400">ç„¡è©³ç´°åˆ†æå…§å®¹</p>';
            
            const rating = data.rating ? 'â­'.repeat(data.rating) : 'æœªè©•åˆ†';
            document.getElementById('detail-rating').innerText = rating;
            document.getElementById('detail-feedback').innerText = data.feedback || 'ç„¡';

            document.getElementById('detail-modal').classList.remove('hidden');
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.add('hidden');
        }

        function resetApp(targetView) {
            state.question = '';
            state.name = '';
            state.password = '';
            state.age = '';
            state.numbers = [null, null, null];
            state.currentDocId = null;
            currentRating = 0;
            
            document.getElementById('question-input').value = '';
            document.getElementById('user-name').value = '';
            document.getElementById('user-password').value = ''; // Reset pwd field
            document.getElementById('user-age').value = '';
            document.getElementById('user-gender').value = 'ç”·';
            document.getElementById('feedback-text').value = '';
            document.getElementById('history-search-name').value = '';
            document.getElementById('history-search-pwd').value = '';
            document.getElementById('history-list').innerHTML = '<div class="text-center py-10 text-stone-400 text-sm">è¼¸å…¥è³‡æ–™å¾Œé–‹å§‹æŸ¥è©¢</div>';
            
            document.getElementById('ai-content').innerHTML = '';
            document.getElementById('ai-content').classList.add('hidden');
            document.getElementById('ai-loading').classList.remove('hidden');
            document.getElementById('static-desc').innerText = '';
            document.getElementById('feedback-section').classList.add('hidden');
            document.getElementById('feedback-form').classList.add('hidden');
            document.getElementById('feedback-thanks').classList.add('hidden');
            document.querySelectorAll('.star-btn').forEach(btn => btn.classList.add('grayscale'));
            document.getElementById('rating-saved-msg').style.opacity = '0';

            const btn = document.getElementById('flip-btn');
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            document.getElementById('flip-btn-text').innerText = "ç¿»é–‹ç¬¬ä¸€é ";
            document.getElementById('flip-hint').classList.add('hidden');

            switchView(targetView || 'view-cover');
        }

    </script>
</body>
</html>